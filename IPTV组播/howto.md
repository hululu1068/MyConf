# 〇、前情提要
虽然没有开issues，但还是经常有人千辛万苦拐弯抹角的联系到我，主要就是询问如何甩开机顶盒观看iptv、解决抢电视一类问题什么的，甚至不交钱白嫖的，对此我也花了不少的时间逐一讲解、帮助，后来我想了想，本来也不是什么难事儿，干脆系统一点儿完整写下来贴出来吧，对此，就有了如下内容。

首先本文是对应北京联通和北京移动所针对性撰写，其他地区和其他运营商有可能存在差异，本文可以提供参考。（主要是区别于组播数据都需要鉴权的那些，一个是服务商局端校验设备mac地址，那么对应办法就是在路由器接口中，更改为你电视盒子背面的mac地址，还有验证账户的，那就改对应协议填写对应的账号和密码。这里我自己没有用过，仅抛砖引玉提供思路，其实说来说去套路就这么些，总能绕过去的。还有一个就是光猫本身并没有自带或者说局端没有默认下发IPTV的配置，这种情况也很简单，照着本区域内其他有相关配置的人光猫里头，在自己光猫新建个接口，把相关信息抄过来就可以了，邻里关系不好，同城又谁都不认识，网上也没人分享也求不到，那你就办一个月iptv，交一个月钱，到时候你光猫里就有相关信息了，自己记下来备用即可）

其次，本文针对新手人群为主，条条大路通罗马，其中可变通的部分我可能会介绍到，也或者略过不提，其最终目的就是以最小成本调通设备，如果在这种前提下你有更优雅的方式方法，欢迎（不辞辛劳）联系探讨

我本人不爱抓图，本文会是纯文字教学，会写的比较详细，尽量做到包教包会，请具备耐心，一步一步跟着来，不会存在什么障碍，照着来，一定行

最后，本文包括本github项目仅为技术交流学习所用，本人不对由此产生的一切后果负责

如果你充分理解了以上三点，尤其是最后一点，那么请继续往下看

# 一、准备工作
## 1、宽带
已经安装好宽带产品，并且光猫可以正常使用，家里已经可以通过宽带正常上网，正常通过盒子看iptv（或者极端一些的情况比如宽带撤了不能上网，但光纤线路和光猫设备保留，或者还没来得及开通iptv，想先体验一下试试看什么的……）

## 2、路由器
自购第三方路由器一台以及对应数量的网线，路由器可以刷第三方固件openwrt最佳（本文着重介绍openwrt环境下的使用），梅林（merlin）、老毛子（padavan）等系统亦可。如果不能刷第三方固件，那么路由器官方系统需要具备IPTV相关能力（如果不行，就更新固件到最新版本看看，路由器品种型号众多，配置千奇百怪，这里就只能纯属于撞大运，蒙着来）

## 3、电脑
带有网线接口（RJ45）的电脑一台（不带网线接口但有无线网卡的话也凑合，手机、平板都行，忽略下文第2步，路由器设置时采用无线连接进行、第4步根据第1步的判断盲操多试试即可）

# 二、具体实施
## 1、光猫检查
宽带装好后，先什么都不要动、不要调，就用默认光猫拨号的路由模式，不要改桥接，观察一下附带光猫的接口哪个是上网，哪个是iptv，或者是可以四个口盲插类型。你可以看光猫说明书，可以看光猫接口处外观印刷或者按照后文方法试验确认。目前北京大部分新的光猫都是可以盲插的，几个接口都是高速的，也就是一个接口同时可以上网和看iptv，一些光猫是最后的一个口专门看iptv，前几个口上网，甚至有些旧型号只有第一个接口是千兆，其余都是百兆。如果你的光猫是支持盲插的，那么你可以单线复用，即一根网线插到路由器负责上网和iptv。也可以两根线都插到路由器，一根负责上网一根负责iptv。如果你的光猫不能盲插，那么你只能用两根网线从光猫接到路由器上，分别上网和iptv用.。或者你根据你的需求，打电话给运营商试试要求他们给你换个更好的光猫。还有一个需要看清楚后边用得到的，就是你光猫的网段，一般情况下默认都是192.168.1.1，如果不是，务必看清、记住你光猫的网段

## 2、环境验证
上一步已经判断了哪个口可以看iptv，这一步就来验证一下，直接用网线连接电脑和光猫，光猫先试第一个口，电脑的网卡采用自动获取（DHCP客户端模式）地址，插上网线以后稍等一会儿，或者在cmd中输入ipconfig /renew后等待结果返回，然后打开支持组播观看的播放器，比如VLC、MPC BE，播放比如北京联通的 rtp://239.3.1.241:8000 或者北京移动的rtp://228.1.1.115:8000 ，如果可以播放出画面，那接下来再看看能不能上网，如果还可以上网，那光猫这个接口就属于可以单线复用，大概率也支持几个口盲插（你可以插剩下几个光猫接口也试试）。如果你只有特定接口可以上网，特定接口可以看组播的iptv，那么你就记清哪个口可以做什么。

## 3、网段设置
电脑单独用网线接入只插了电脑网线的路由器lan口（除了电脑，路由器别的都别插）。首先检查路由器lan的网段是否与光猫重合，如果重合了，就换一个，建议用192.168.123.1，这样的话就可以直接用本github项目的列表直接看单播的电视了。这里以openwrt举例（其他系统类似），电脑自动获取本地ip地址后，在cmd窗口中键入ipconfig /renew等待返回后查看网关是多少，直接浏览器访问该地址，进入后台在“网络-接口-lan”里边把地址改好。

## 4、路由器关键设置
**关键一步，分两种情况**，就是前文提到的依据光猫类型的不同，分为单线复用（一根线同时上网&看iptv），以及双线连接。

### 4.1、路由器关键设置-双线
这里先说**双线的情况**。你需要用两根网线分别连接光猫的两个口（根据前文判断一个口负责上网，一个负责看iptv），网线另一端连接你的路由器，负责上网的连接wan口，负责传输组播iptv数据的随便接到剩余哪个lan口都行。

#### 4.1.1、路由器关键设置-双线-openwrt
先以openwrt举例，在接口设置中，wan就按照你的设定直接dhcp客户端自动获取即可。重点是另一根负责传输iptv组播数据的网线，先新建接口，名称tv，协议dhcp客户端，接口的话看看你iptv的线接到哪个物理接口，就选哪个，这里以eth3举例（一般默认物理wan口是eth0，那么如果你一共4个物理接口，eth3就是第四个物理接口，eth1就是挨着物理wan口的第二个物理口，自己数数是哪个物理接口）。这时候再到lan的设置，在物理设置中去掉刚刚的接口，也就是eth3，并且开启igmp snooping。

#### 4.1.2路由器关键设置-双线-老毛子、梅林
如果你是老毛子，或者梅林，你就试试插好线以后直接按第五步往下走，如果不行，就继续看4.2部分（我已经记不清梅林和老毛子相关默认设置是什么、双线行不行了，你们自己试一下，印象里单线应该是没问题的，双线自己试试）。

#### 4.1.3、路由器关键设置-双线-其他
如果你是其他不具备相关能力的普通路由器，这种情况你只能在目前的状态下去第六步试试看直接播放组播（一众tplink其实已经可以看组播的iptv了），如果不能播放，那就继续看4.2部分对应内容

### 4.2、路由器关键设置-单线
这里再说**单线的情况**，网上很多人说划vlan，其实不用，因为光猫破解越来越难，你拿不到权限，根本不能设置vlan，与其花钱新买一个破解好的光猫（或者好破解的），或者添加一个带有管理功能的高级交换机，不如花钱买一个好一些的路由器刷个openwrt来得实在，然后甚至打电话叫运营商直接后台给你改光猫为桥接用路由器来拨号————扯远了，单线的话就是一根线连接光猫和路由器，路由器要插到wan口，光猫用哪个口按照前文判断来（大概率可以盲插）

#### 4.2.1、路由器关键设置-单线-openwrt
这里仍旧先以openwrt举例，光猫网线连接你路由器的wan口，然后需要在你的wan口（一般默认物理接口为eth0）建立两个连接，默认应该已经有一个了，默认的那个连接就叫wan，负责上网，采用dhcp客户端自动获取即可。重点来了，这时候新建一个新的接口，物理接口也选eth0，取名叫tv，协议是dhcp客户端，在tv接口的高级设置里，网关跃点填大一些，比如22（别问为什么不是20，因为没小键盘，因为懒，懂？）。

#### 4.2.2、路由器关键设置-单线-老毛子、梅林
梅林和老毛子与刚刚4.1.2一样，插好线就直接试第五步（我印象里单线是可以的，或者两者都可以？我记不清了，你们自己试试，总归绝对是可以的）

#### 4.2.3、路由器关键设置-单线-其他
其他没有iptv包括找不到igmp选项的路由器，去第六步播放组播试试吧，如果不行，那这破玩意儿就扔了吧…破烂儿留着干嘛使啊……实在心疼，不想扔，留着做ap我估计也好不到哪儿去，年代久远的老古董，功能不行，性能肯定也太差了跟不上时代了……

## 5、组播转单播
这一步要把组播数据转为单播数据（不具备组播转单播能力的路由器不用看这里了，客户端直接看组播数据的iptv吧，如果可以的话…）。

### 5.1、组播转单播-openwrt
依旧先以openwrt详细说明，那就是udpxy这个程序，如果没有，自己opkg安装一个或者编译固件时候带上。在udpxy的luci里勾选启用，在Bind IP/Interface里填写你lan的接口，一般默认为br-lan，在Source IP/Interface里填写第4步你组播接口的地址，双线的那个是eth3，单线的是eth0，端口随便来一个只要不冲突即可，推荐23234，这样你可以直接用本github项目的列表看单播iptv了

#### 5.1.1、组播转单播-openwrt-防火墙
这里额外说一下openwrt的防火墙，我之前刚刚接触openwrt时候，防火墙这里踩了不少坑，iptv死活看不了，最后发现是防火墙的逻辑没搞对…我现在的做法比较粗犷，我默认允许全部接口的全部流量自由进出，默认自带的防火墙规则也全删了，然后额外添加了一条wan口忽略icmp（ping），之后再扫描了我的外网ip，0-65535端口全扫了，不知道为何80，443，53是开放的（但是外网也不能提供对应服务），我本机web管理权只允许lan接口，而且没有443对应服务，dns也设置为仅服务于内部…不管了，我直接添加对应规则把这几个端口wan进来的流量丢弃就完了，属于另辟蹊径吧。如果你扫到其他开放的端口，你可以采取类似措施直接添加防火墙规则即可，其余的流量全部放行。具体操作流程就是先把lan到wan和wan到lan全部的进出和转发都勾选上，再到流量规则里把系统自带的规则都删掉，再添加wan口那几个端口丢弃和一个icmp丢弃就行了，很简单很高效。或者说如果你觉得不放心，那么你可以按照传统的思路指定tv接口一个新的防火墙区域，手工添加对应的igmp和udp规则。

### 5.2、组播转单播-老毛子、梅林
梅林和老毛子同样有组播转单播的组件，填写端口23234并且启用即可（印象里梅林和老毛子不用设置接口什么的，默认监听0.0.0.0？），但是要记得找找igmp snooping勾上，还有找找网络风暴，根据设备硬件能力吧，写个5m意思意思？差不多吧反正平时都看单播而且已经开了igmp snooping。这个时候你可以ssh上路由器，ps命令看一下udpxy进程是不是已经跑起来了（梅林和老毛子都用udpxy的）。老毛子和梅林的防火墙不用调，我记得默认就没问题

## 6、客户端播放
在客户端安装对应的播放程序，安卓盒子或者电视推荐iptv pro，pc推荐vlc和mpc be，mac和ios推荐vlc。打开播放程序，如果你的路由器有组播转单播服务，那么你可以看单播了，北京联通的话类似 http://192.168.123.1:23234/rtp/239.3.1.241:8000 192.168.123.1是你路由器的地址，23234是你组播转单播程序的端口。当然你的路由器ip和对应服务端口如果和我一样，你就可以直接用播放程序打开本github项目的m3u列表比如联通的IPTV-Unicom.m3u或移动的IPTV-Mobile.m3u，把列表的在线地址直接添加到程序里，这样我这边更新了，你那里什么都不用调整，直接可以看新的频道。如果你是tplink什么的路由器，那么你只能以组播形式看iptv了，比如北京联通的 rtp://239.3.1.241:8000 或者北京移动的 rtp://228.1.1.115:8000 ，列表文件联通的是IPTV-Unicom-Multicast.m3u，移动的是IPTV-Mobile-Multicast.m3u

### 7、其他提示
我个人是倾向于igmp流量在路由里不进行转发的，内网我本人从来不看组播，直接看单播就可以了，如果有需要，可以在老毛子和梅林自己打开转发设置，openwrt可以安装igmpproxy或omcproxy。另外可能有聪明的伙计没有按照教程来，比如光猫改了桥接用路由器拨号，比如光猫里关掉了dhcp服务，比如光猫已破解并且还原配置界面可以划分vlan一类的，嗯，如果能用那就都挺好的。尤其是搭配那些自定义程度很低的路由器用的，那你可能iptv就调不通了，我这里的建议是如果你调不通，相关原理也不能完全理解透彻，那就先不要自作聪明，按照教程一步一步来吧。如果你用自定义程度很高的路由器系统比如openwrt，或者用老毛子、梅林且手撸脚本能力很强，那你肯定是前文所说的条条大路通罗马了，不过那都是后话了，本文你也用不上不是吗：）当然，在openwrt里进行pppoe拨号上网，并且光猫关掉dhcp服务是比较科学的，只需要打电话给运营商告诉他们自己要改桥接，对方tr069远程给你下发配置，3分钟的事儿（算上语音等待的话前后5分钟？），你光猫就桥接了，关闭dhcp服务的话我用过的几个光猫，其背面印刷的user权限就都可以调整了，之后openwrt里wan的接口改pppoe协议，添加你的宽带拨号账户，然后接口tv把dhcp客户端改成静态地址，自己添加好ip就可以了。还有一个事儿，好像还有个都市传说，就是很早以前说北京联通的IPTV盒子必须每个月至少使用一次，不然不激活一下的话，会被取消掉服务？我好几年没开过那个了，呃，也不是，一年多以前听说iptv盒子换支持4k60fps（要不就是4k120fps？只开过一次，忘了）高级货的时候儿，我打电话让他们给我换了一个，当时小哥上门过来时候开了那么一下，当然，我那个时候提前把光猫的dhcp服务打开了，不然iptv盒子注册不上，毕竟白嫖的新款高级的iptv盒子，里边没有相关配置：）好吧，我就想说我iptv盒子属于基本没开过，iptv服务也一直在，没被取消掉。

# 最后
本github项目注明了CC0协议，本文属于该项目的一部分，但是我仍旧希望转载本文的各位可以保留全文并且注明出处——[https://github.com/qwerttvv/Beijing-IPTV](https://github.com/qwerttvv/Beijing-IPTV "https://github.com/qwerttvv/Beijing-IPTV")

大概没什么可啰嗦的了，就这样

祝各位好运

